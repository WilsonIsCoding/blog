---
title: 訂單系統開發紀錄
description: 訂單系統開發設計反思
slug: leju-order-system-design
date: 2025-10-26
type: Post
---

## 背景說明

<p>樂居今年要開第三種產品線，前兩個分別是樂居Pro跟社區達人，兩種都是屬於訂閱服務，而這次要開發的是樂居刊登置頂的服務，簡單來說就是使用者可以花錢將自己的物件買廣告，並在我們的各種頁面上可以更凸顯。</p>
<p>由於前面有兩個已經可以參考的開發先例，所以這次實作的重點會放在我們的資料庫跟金流系統如何交互</p>

## 釐清系統需求
<h3>Functional requirements</h3>
<p>1.使用者在成立訂單後，這筆物件需要被lock住，不可以被其他人成立訂單</p>
<p>2.成立訂單五分鐘內如果沒有付款成功，訂單內所有的物件會被release出來，讓其他人可以加入購買</p>
<h3>Non-Functional requirements</h3>
<p>1.金流付款成功後，需要在半小時內前台需要顯示</p>
<p>2.成立訂單到跳轉到tappay付款頁面的api response希望可以越快越好</p>

## 系統實做
<p>所以使用者建立訂單的流程如下</p>
<p>前端按下成立訂單->檢查這個使用者是否五分鐘內建立過訂單->檢查購物車內每筆物件是否都可以置頂->檢查現在是否有其他還沒結帳的訂單物件->成立訂單->打tappay結帳->回傳給前端response url->前端付款->後端確定訂單是否完成</p>
<p>付款流程圖如下</p>
![first normalization photo unload](/images/tappay.png)

## 服務搭配
<p>因為這個系統的MVP需要在一個月內前完成，所以思考的架構模式是高敏捷跟低負擔。也就是說希望這東西可以在現有的系統跟工具下進行開發，即便有其他的log system或是拆表來更好的貼合維護的方法，還是就先以我們手上有的工具為主</p>
<h3>回應速度</h3>
<p>前面講到的function require，系統需要防範同樣一筆物件被重複購買，這邊為了避免資料庫的重複查詢，我們使用redis來阻擋</p>
<h3>可靠度</h3>
<p>雖然說如此，但是<b> 「檢查每筆訂單是否都可以被置頂」 </b>這件事情仍然是一件消耗資源的操作，所以這邊最後選擇限制在流量上避免db負擔過高，我們在cloudFlare限制時間區間內的流量來做到流量控管。</p>

## 總結
<p>金流系統也是系統面試的常客，所以這次有這個任務馬上就自告奮勇接下來，雖然開發進程蠻趕，而且需要看的東西包含之前已經開發完的模組流程跟tappay串接文件，但整套設計包含思考一致性、安全性跟維護性的過程，在把流程圖畫出來，最後跟同事分享跟開發實作的流程也是覺得非常有趣跟好玩。比較可惜的是這次沒有比較多碰到維運跟網路溝通的部分，不然我覺得有些的功能跟阻斷如果可以做在那個區塊，對我們的系統回應速度跟完整度應該會更高。</p>