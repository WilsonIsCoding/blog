---
title: 訂單系統開發紀錄
description: 訂單系統開發設計反思
slug: leju-order-system-design
date: 2025-10-26
type: Post
---

## 背景說明

<p>今年，樂居即將推出第三條產品線。前兩項產品──樂居 Pro 與 社區達人──都屬於訂閱制服務，而這次要開發的是全新類型的產品：刊登置頂服務。
簡單來說，使用者可以付費將物件購買廣告曝光，讓物件在我們的各類頁面上更醒目、曝光更高。</p>

<p>有了前兩個系統可參考，這次的重點反而放在 資料庫設計 與 金流服務之間的互動方式，如何在既有環境中，以快速又可靠的方式把整套流程串起來。</p>

## 釐清系統需求
<h3>Functional Requirements</h3>

<p>1.訂單成立後該物件需被鎖定，避免同一物件同時間被不同使用者購買。</p>

<p>2.若訂單在 5 分鐘內未完成付款，該訂單所有物件需自動 釋出，供其他使用者購買。</p>

<h3>Non-Functional Requirements</h3>

<p>1.金流付款成功後，前台需在 30 分鐘內完成更新並顯示結果。</p>
<p>2.從使用者點擊「成立訂單」到跳轉至 TapPay 付款頁面的 API 回應時間需 越快越好，不能拖到整體使用體驗。</p>

## 主要系統流程

使用者從前端建立訂單流程如下：

前端點擊「成立訂單」

檢查該使用者是否在 5 分鐘內建立過訂單

檢查購物車內每筆物件是否符合置頂資格

檢查該物件是否已被其他訂單鎖定

建立訂單

呼叫 TapPay API 建立付款

<p>付款流程圖如下</p>
![first normalization photo unload](/images/tappay.png)

後端回傳付款網址給前端

使用者付款 → 後端接收金流回調 → 更新訂單狀態

付款流程如下圖：

技術考量與架構選擇

這次目標是在 一個月內完成 MVP，因此架構設計的原則是：

👉 高敏捷：能夠快速開發完成

👉 高擴展：目前還不確定上線狀態，希望保留多一點的系統需求空間

👉 最大化利用既有工具，不額外開太多系統負擔

雖然更完整的方案可能會拆更多表、補更多 log system，但在時程考量下，我們選擇了更務實、可快速實作的方式。

1. 回應速度：避免同筆物件被重複購買

「同一物件不能同時成立訂單」是整套系統最關鍵的規則。
如果使用 DB 鎖或頻繁查詢，很容易拖慢整體性能。

因此這次我們採用 Redis 來做物件鎖定（lock），
直接阻擋同時間的重複訂單成立請求，既快又能有效減少 DB 壓力。

2. 可靠度：置頂資格檢查是重操作

「每筆物件是否可置頂」的檢查邏輯較複雜，
即便我們做了 cache，也依然是相對吃資源的操作。

因此，我們補上一層防護：
利用 Cloudflare 對 API 做流量限制（Rate Limiting），
避免瞬間湧入大量檢查導致 DB 被打爆。
以小成本就能有效提高整體穩定度。

開發過程心得

金流系統一直都是工程師常見的面試題，這次剛好有機會實際從零規劃並實作整套流程，當然立刻接下任務。

在這個過程中，一邊研究既有模組流程、一邊閱讀 TapPay 文件、一邊梳理資料一致性與風險，最後再把整套流程圖做出來、與同事討論與落地，整個過程都非常有趣。
雖然這次比較少碰到維運與網路層面的最佳化，但我相信如果這些部分也能納入，整體的反應速度與可靠性還能再更上層樓。

<p>流程圖</p>
![流程圖](/images/payment_design.png)