---
title: 訂單系統開發紀錄
description: 訂單系統開發設計反思
slug: leju-order-system-design
date: 2025-10-26
type: Post
---

## 訂單系統
<p>訂單系統一直是面試時的經典大考題，通常會考驗設計者在面對資料一致性跟系統可用性上的設計</p>
<p>雖然之前有在系統設計的考題中想過類似的設計，那時候也通常會用最適合的工具來處理各種問題</p>
<p>而今年，公司即將推出第三條產品線。而這次要開發的是全新類型的產品：刊登置頂服務。</p>
<p>比較特別的是，我不太需要從頭做起，而是可以參考公司既有的兩個系統：</p>
<p>好處是利用既有的模組來加速開發</p>
<p>壞處是有些服務因為是舊系統開發的，技術債比較重，無法直接套用最適合的工具</p>

## 刊登置頂服務
<p>我們這次付費的服務是將我們系統上超過100萬筆以上的物件資料，過往只能透過公司向我們直接購買某個區域的特定身份的物件，使他們在前端介面上擁有更高的權重而被看見</p>
<p>而這次我們要開發的系統是讓一般使用者可以自行選擇想要置頂的物件，並且透過線上金流付款來完成訂單</p>

## 釐清系統需求
<p>而在開發前，確定系統需求是非常重要的事情，理解需求，才能夠先訂下系統的設計方向，避免之後設計出來的東西完全不符合需求，或是要花費沒辦法接受的系統資源</p>

<h3>Functional Requirements</h3>

<p>1.訂單成立後該物件需被鎖定，避免同一物件同時間被不同使用者購買。</p>
<p>2.若訂單在 5 分鐘內未完成付款，該訂單所有物件需自動 釋出，供其他使用者購買，而付款時，訂單狀態要從建立變成待付款。</p>
<p>3.付款完成後的訂單需要在五分鐘內開立發票並寄送到使用者的裝置中（email）</p>

<h3>Non-Functional Requirements</h3>

<p>1.金流付款成功後，前台需在 30 分鐘內完成更新並顯示結果。</p>
<p>2.從使用者點擊「成立訂單」到跳轉至 TapPay 付款頁面的 API 回應時間需 越快越好，不能拖到整體使用體驗。</p>

## 主要系統流程

使用者從前端建立訂單流程如下：

1.前端點擊「成立訂單」

2.檢查該使用者是否在 5 分鐘內建立過訂單

3.檢查購物車內每筆物件是否符合置頂資格

4.檢查該物件是否已被其他訂單鎖定

5.建立訂單

6.呼叫 TapPay API 建立付款

<p>購買流程圖</p>
![流程圖](/images/payment_design.png)

## 系統設計重點
1. 回應速度：避免同筆物件被重複購買

「同一物件不能同時成立訂單」是整套系統最關鍵的規則。
如果使用 DB 鎖或頻繁查詢，很容易拖慢整體性能。

因此這次我們採用 Redis 來做物件鎖定（lock），
直接阻擋同時間的重複訂單成立請求，既快又能有效減少 DB 壓力。

2. 可靠度：置頂資格檢查是重操作

「每筆物件是否可置頂」的檢查邏輯較複雜，
即便我們做了 cache，也依然是相對吃資源的操作。

因此，我們補上一層防護：
利用 Cloudflare 對 API 做流量限制（Rate Limiting），
避免瞬間湧入大量檢查導致 DB 被打爆。
以小成本就能有效提高整體穩定度。

## 開發過程心得

<p>這次設計的流程還是有一些可以改進的地方</p>
<p>在一開始理解需求時，只把需求拆分成required跟nice to have，兩種，但應該還可以拆分成最緊急跟可之後補上的這兩種，一開始沒有做好這種規劃
    導致前期在寫程式時有點綁手綁腳，總想要一次做到位，而不是專注在那些最重要核心的基礎建設</p>
<p>自己覺得在做這種設計時，應該就像是蓋房子一樣，先從最基本的需求開始建設，不過度設計，先設計出一個能符合最必要、緊急需求的MVP，在慢慢慢慢把基礎建設補上去</p>
<p>並在開發過程中重視拔草跟重構，應該才會是比較適合的方式</p>