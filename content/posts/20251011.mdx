---
title: 紀錄系統開發紀錄
description: 紀錄系統開發設計反思
slug: leju-record-system-design
date: 2025-10-11
type: Post
---

## 記錄系統
<p>當我們提到紀錄系統時，第一個會被想到的通常是 Google Analytics（GA）。
透過在網頁中安裝 GA 提供的 JavaScript SDK，我們可以將使用者在頁面上的行為事件
（例如頁面瀏覽、點擊、跳轉、來源流向等）回傳到 Google 的伺服器，
並在 GA 的後台介面中即時地查看統計結果。</p>
<p>在大部分的前端場景或是商業決策中，GA 其實都可以大部分滿足需求，但假設我們想要捕獲的事件是比較特別的情況，
    比如：我們想要知道使用者點擊特定按鈕的次數，想要知道某種特徵資料的點閱次數，而這些東西是沒有辦法直接透過網址去分辨出來的。
    那這時候除了把GA報表下載下來在做資料分析以外，我們可能就需要自己架一個紀錄系統來達到這個目的。</p>
<p>
在設計一個功能或是系統時，我們需要知道這個系統的highest priority是什麼。
首先，我們可以預期使用者的操作會是高度頻繁的，
也代表這類系統會面臨非常高的寫入頻率（high write throughput）。
如果他是直接對DB進行操作的話，那麼DB的負擔會非常重，甚至可能會影響到其他系統的運作。
同時，payload的大小也需要注意，我們一定不會希望一個請求又常發生又難處理。
另外，資料需要保存多久的時間，還有資料需要保存的大小，這都是在設計時需要「提前」先被考慮的事情。
</p>

<p>在有這些紀錄系統的基本理解後，我們就可以進入到需求分析了。</p>
## 需求釐清
<p>首先 我們預期每天會有大約10萬的使用者在我們的頁面上瀏覽房屋資訊</p>
<p>每個使用者平均會瀏覽5筆房屋資訊</p>
<p>每個房屋資訊會有4種互動行為（瀏覽、留單、打電話、連結）</p>
<p>我們需要保存這些資料60天</p>
<p>每筆資料id的大小大約是14bytes</p>
<p>互動行為的資料大小大約是4 bytes</p>
<p>不用馬上看到資料更新，可以隔天才更新</p>

<p>每日事件數 = 100,000 × 5 × 4 = 2,000,000 筆/日</p>
<p>所以我們的qps（Queries Per Second）大約是 2,000,000 / 86,400 = 23.15 qps</p>
<p>但使用者大部分都是白天在使用，所以qps通常會在乘以2讓他更貼近真實的情況，也就大概是46</p>

<p>每日資料量 = 2,000,000 × 30 bytes = 60,000,000 bytes = 60 MB</p>
<p>60天資料量 = 60 MB × 60 = 3,360 MB ~= 3 GB</p>

<p>所以我們的系統需要能夠處理大約46 qps的寫入請求，並且在60天內保存大約3 GB的資料。</p>
<p>在有這樣最初步的設計之後，剩下的就是開始去想怎麼實作這個系統了。</p>

## 實作過程
<p>首先，紀錄這件事情應該是不要直接對DB進行操作，舉個例子，今天股市9.開盤，作為系統服務商，我一定需要提前預備好9.那一剎那，所有請求馬上打進來的情況。</p>
<p>我們在做系統設計時，也需要考慮到這種極端情況，假設今天有一個房屋資訊突然爆紅，所有人都在看這個房屋資訊，那麼我們的系統是否能夠承受這樣的高負載？</p>
<p>所以這時候 最初一個緩衝區是必要的，這個緩衝區可以是使用Redis這種in-memory database，來先暫存這些高頻率的請求，然後再由後端的排程任務，定期將這些資料批次寫入到DB中。</p>
<p>所以概念上更像是一個「先寫入緩衝區，再批次寫入DB」的架構。讓DB在白天可以去處理真正重要 需要及時被響應的請求，而在夜深人靜的時候，我們再把這些不那麼緊急的事情交給DB去寫入</p>  

<p>但這邊還延伸出一個問題</p>
<p>前端每次的拿取可能是要多筆物件，而如果每次都是要向那個百萬大表去請求，那麼效能一定會很差</p>
<p>這個地方其實也有蠻多的解決方式，我們可以選擇用big query這種大數據的解決方案，或是用clickhouse這種專門處理分析型查詢的資料庫，雖然可能會有一點失真，但也可以以
    最小負擔的方式去解決這個需求。</p>

<p>或者是我們也可以用另外一張整理表定期去濃縮前一張daily表，使用者進來時，不是像上面的每日資料表去請求所有的資源，在進行60天內的計算，最後在回傳給使用者</p>
<p>而是直接向整理表拿資源，告訴他說 我要這幾筆資料的成效，直接轉拋給前端</p>
<p>後來我們選擇了第二種方式，雖然決定在原有的設計上用額外的空間來換取回傳的速度跟資源。但在真正的商業情境下，這也是一個非常普遍的以空間換取時間的策略。</p>

## 設計結語
<p>整體來說，這次的設計是一個蠻有成就感的一次回顧，重新把設計思考這本書拿出來，羅列各種資料的儲存跟響應的成本，並把成本轉換成時間跟錢來跟PM討論。
    並跟同事確定現有架構能夠負荷 在需求跟技術兩者間取得平衡</p>
<p>最後也順利完成了這個系統的設計，並且在過程中實作了一次腦中的系統設計，真的是一次蠻棒的經驗</p>

[功能設計圖](https://app.diagrams.net/#G1TrCiNMWarT3FviWzQxkwfooHbxk2zkNE#%7B%22pageId%22%3A%22tild1c0V44OccYTnvrr0%22%7D)
![first normalization photo unload](/images/metric_design.png)